# توثيق واجهات برمجة التطبيقات (API)

> **آخر تحديث:** 2025-11-12  
> **بيئة مستهدفة:** منصة الحجز العقاري الليبية

هذا المستند يوفر نظرة مرجعية لواجهات REST المخطط لها. جميع الاستجابات تستخدم JSON، ويتم تأمين النقاط الحساسة عبر مصادقة JWT مع تحديث الرموز عند الحاجة. يجب إرسال كل الطلبات عبر HTTPS.

## 1. المصادقة وإدارة الجلسات

| الطريقة | المسار | الوصف | المصادقة | ملاحظات |
|---------|--------|--------|-----------|----------|
| POST | `/api/v1/auth/register` | تسجيل مستثمر أو مستأجر جديد | لا | يتطلب بيانات الهوية والتحقق عبر SMS/Email |
| POST | `/api/v1/auth/login` | تسجيل الدخول واستلام رمز JWT | لا | معدل محاولات محدود، يتطلب MFA عند الشك |
| POST | `/api/v1/auth/logout` | إنهاء الجلسة الحالية | نعم | إبطال التوكن في القائمة السوداء |
| POST | `/api/v1/auth/refresh` | تجديد رمز الوصول | نعم (Refresh Token) | نافذة صلاحية قصيرة |
| POST | `/api/v1/auth/verify` | رفع مستندات التحقق من الهوية | نعم | يدعم صور الهوية بصيغة آمنة |

## 2. إدارة المستخدمين

| الطريقة | المسار | الوصف | المصادقة | ملاحظات |
|---------|--------|--------|-----------|----------|
| GET | `/api/v1/users/me` | الحصول على الملف الشخصي | نعم | يعكس إعدادات اللغة والعملة |
| PATCH | `/api/v1/users/me` | تحديث البيانات الأساسية | نعم | يتحقق من الحقول الحساسة |
| PATCH | `/api/v1/users/me/preferences` | تحديث التفضيلات (لغة، عملة، منطقة زمنية) | نعم | يحفظ في ملف محايد ويعرض بصيغة محلية |
| GET | `/api/v1/users/{id}` | عرض ملف مستخدم (للمالك أو الإدارة) | نعم (صلاحيات) | يخفي البيانات الحساسة حسب الدور |

## 3. إدارة العقارات والصالات

| الطريقة | المسار | الوصف | المصادقة | ملاحظات |
|---------|--------|--------|-----------|----------|
| POST | `/api/v1/properties` | إضافة عقار جديد | نعم (مستثمر) | يدعم تحديد سعر يومي/شهري/بيع |
| GET | `/api/v1/properties` | بحث وتصفية العقارات | اختياري | يدعم الفلاتر حسب المدينة، السعر، التقييم |
| GET | `/api/v1/properties/{id}` | تفاصيل العقار | اختياري | يعرض التقويم وتوفر العربون |
| PATCH | `/api/v1/properties/{id}` | تحديث بيانات العقار | نعم (مالك العقار) | يتضمن تبديل حالة الصيانة |
| DELETE | `/api/v1/properties/{id}` | حذف عقار | نعم (مالك/إدارة) | يستخدم Soft Delete مع سجل تدقيق |
| POST | `/api/v1/properties/{id}/media` | رفع صور أو ملفات | نعم | يفحص النوع والحجم ويولد روابط موقّتة |
| GET | `/api/v1/properties/{id}/availability` | عرض التوفر | اختياري | بيانات مبنية على UTC مع عرض محلي |
| POST | `/api/v1/halls` | إضافة صالة مناسبات | نعم (مستثمر) | يشمل تسعير صباحي/مسائي/يومي |
| GET | `/api/v1/halls/{id}/slots` | جلب الفترات المتاحة | اختياري | يوضح الفترات المحجوزة لكل يوم |

## 4. إدارة الحجوزات والعربون

| الطريقة | المسار | الوصف | المصادقة | ملاحظات |
|---------|--------|--------|-----------|----------|
| POST | `/api/v1/bookings` | إنشاء طلب حجز | نعم (مستأجر) | يسمح بإرفاق رسالة صوتية وعربون اختياري |
| GET | `/api/v1/bookings` | قائمة الحجوزات (حسب الدور) | نعم | يصفّي حسب الحالة والتواريخ |
| GET | `/api/v1/bookings/{id}` | تفاصيل الحجز | نعم | يتضمن سجل الموافقات والدفع |
| PATCH | `/api/v1/bookings/{id}/status` | موافقة/رفض الطلب | نعم (مالك العقار) | يرسل إشعارات فورية |
| POST | `/api/v1/bookings/{id}/deposit` | دفع العربون أو تسجيله نقداً | نعم | يدعم تكامل بوابة الدفع المحلية |
| POST | `/api/v1/bookings/{id}/checkin` | تأكيد استلام المفاتيح | نعم (مالك) | يسجل التوقيت بالـ UTC |
| POST | `/api/v1/bookings/{id}/checkout` | إقفال الحجز وتحرير العربون | نعم | يحسب الرسوم النهائية |

## 5. الاتصالات والرسائل

| الطريقة | المسار | الوصف | المصادقة | ملاحظات |
|---------|--------|--------|-----------|----------|
| POST | `/api/v1/messages` | إرسال رسالة نص/صوت مرتبطة بحجز | نعم | يحفظ الملف في مخزن آمن |
| GET | `/api/v1/messages/thread/{bookingId}` | جلب المحادثة الخاصة بحجز | نعم | يدعم البث المباشر عبر WebSocket |
| GET | `/api/v1/notifications` | إشعارات المستخدم | نعم | يشمل تحديثات الدفع والصيانة |

## 6. التقييمات والملاحظات

| الطريقة | المسار | الوصف | المصادقة | ملاحظات |
|---------|--------|--------|-----------|----------|
| POST | `/api/v1/reviews` | إضافة تقييم بعد الإقامة | نعم (مستأجر) | يتحقق من الإقامة المكتملة |
| GET | `/api/v1/reviews` | استعراض التقييمات حسب العقار | اختياري | يدعم التصفية حسب الفترة |
| POST | `/api/v1/feedback` | إرسال ملاحظات إلى إدارة المنصة | نعم | يخزن في لوحة الإدارة مع أولوية |
| POST | `/api/v1/complaints` | شكوى من المستثمر على المستأجر | نعم (مستثمر) | تستلزم متابعة من الإدارة |

## 7. التقارير والمالية

| الطريقة | المسار | الوصف | المصادقة | ملاحظات |
|---------|--------|--------|-----------|----------|
| GET | `/api/v1/reports/overview` | نظرة عامة مالية للمستثمر | نعم (مستثمر) | يظهر الدخل بالدينار الليبي |
| GET | `/api/v1/reports/properties/{id}` | أداء عقار محدد | نعم (مالك) | رسوم بيانية وأرقام إشغال |
| GET | `/api/v1/reports/halls/{id}` | أداء الصالة حسب الفترات | نعم (مالك) | يعرض الصباحي/المسائي منفصلًا |
| GET | `/api/v1/reports/platform` | تقارير المنصة العامة | نعم (إدارة) | يدعم التصدير إلى CSV/PDF |

## 8. الإدارة والرقابة

| الطريقة | المسار | الوصف | المصادقة | ملاحظات |
|---------|--------|--------|-----------|----------|
| GET | `/api/v1/admin/audit-log` | سجل التدقيق | نعم (إدارة) | قابل للبحث حسب المستخدم والزمن |
| PATCH | `/api/v1/admin/users/{id}/status` | تفعيل/تعليق الحساب | نعم (إدارة) | يتطلب سبب موثق |
| GET | `/api/v1/admin/settings` | إعدادات المنصة العامة | نعم (إدارة) | تشتمل على سياسة العربون الافتراضية |
| PATCH | `/api/v1/admin/settings` | تحديث الإعدادات | نعم (إدارة) | يرسل إشعاراً بالأثر على المستخدمين |

## 9. التكاملات الخارجية

| الطريقة | المسار | الوصف | المصادقة | ملاحظات |
|---------|--------|--------|-----------|----------|
| POST | `/api/v1/integrations/payment/webhook` | استقبال Webhook من بوابة الدفع | توقيع سري | يدير أحداث الدفع/الاسترداد |
| POST | `/api/v1/integrations/sms/webhook` | تسليم رسائل SMS | توقيع سري | لتأكيد التحقق أو الإشعارات |
| GET | `/api/v1/integrations/maps/token` | الحصول على توكن خرائط مؤقت | نعم | يحد من الاستخدام وفق الدور |

## معايير عامة

- **التوثيق**: يتم توليد مواصفات OpenAPI/Swagger تلقائياً ونشرها على `/api/v1/docs`.  
- **الإصدار**: تبدأ المنصة بالإصدار `v1`؛ أي تغييرات جوهرية ستتم عبر مسارات جديدة (`/api/v2/...`).  
- **القيود**: فرض حد للطلبات (Rate limiting) لكل دور، مع رسائل خطأ موحدة وفق قاعدة معالجة الأخطاء.  
- **التوطين**: جميع القيم الزمنية في الاستجابات بصيغة ISO 8601 (UTC)، مع حقول إضافية اختيارية للعرض المحلي.

